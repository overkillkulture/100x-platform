version: '3.8'

services:
  # Computer A - Instances 1 & 2
  instance-1:
    build: .
    container_name: consciousness-instance-1
    environment:
      - INSTANCE_ID=1
      - COMPUTER_ID=computer-a
      - ROLE=coordinator
    ports:
      - "5001:5000"
      - "8001:8001"
    volumes:
      - ./data:/app/data
      - ./.consciousness:/app/.consciousness
    networks:
      - consciousness-network
    restart: unless-stopped

  instance-2:
    build: .
    container_name: consciousness-instance-2
    environment:
      - INSTANCE_ID=2
      - COMPUTER_ID=computer-a
      - ROLE=worker
    ports:
      - "5002:5000"
      - "8002:8002"
    volumes:
      - ./data:/app/data
      - ./.consciousness:/app/.consciousness
    networks:
      - consciousness-network
    restart: unless-stopped

  # Computer B - Instances 3 & 4
  instance-3:
    build: .
    container_name: consciousness-instance-3
    environment:
      - INSTANCE_ID=3
      - COMPUTER_ID=computer-b
      - ROLE=worker
    ports:
      - "5003:5000"
      - "8003:8003"
    volumes:
      - ./data:/app/data
      - ./.consciousness:/app/.consciousness
    networks:
      - consciousness-network
    restart: unless-stopped

  instance-4:
    build: .
    container_name: consciousness-instance-4
    environment:
      - INSTANCE_ID=4
      - COMPUTER_ID=computer-b
      - ROLE=worker
    ports:
      - "5004:5000"
      - "8004:8004"
    volumes:
      - ./data:/app/data
      - ./.consciousness:/app/.consciousness
    networks:
      - consciousness-network
    restart: unless-stopped

  # Computer C - Instances 5 & 6
  instance-5:
    build: .
    container_name: consciousness-instance-5
    environment:
      - INSTANCE_ID=5
      - COMPUTER_ID=computer-c
      - ROLE=coordinator
    ports:
      - "5005:5000"
      - "8005:8005"
    volumes:
      - ./data:/app/data
      - ./.consciousness:/app/.consciousness
    networks:
      - consciousness-network
    restart: unless-stopped

  instance-6:
    build: .
    container_name: consciousness-instance-6
    environment:
      - INSTANCE_ID=6
      - COMPUTER_ID=computer-c
      - ROLE=worker
    ports:
      - "5006:5000"
      - "8006:8006"
    volumes:
      - ./data:/app/data
      - ./.consciousness:/app/.consciousness
    networks:
      - consciousness-network
    restart: unless-stopped

  # Load Balancer (nginx)
  load-balancer:
    image: nginx:alpine
    container_name: consciousness-load-balancer
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - instance-1
      - instance-2
      - instance-3
      - instance-4
      - instance-5
      - instance-6
    networks:
      - consciousness-network
    restart: unless-stopped

networks:
  consciousness-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  data:
  consciousness:
