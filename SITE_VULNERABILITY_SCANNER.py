#!/usr/bin/env python3
"""
SITE_VULNERABILITY_SCANNER.py
Automated vulnerability scanner for our own infrastructure

AUTHORIZED TARGETS ONLY:
- https://conciousnessrevolution.io
- localhost development servers
- Railway/Netlify deployments
"""

import requests
import json
from datetime import datetime
from pathlib import Path
from urllib.parse import urljoin

class VulnerabilityScanner:
    """Scan our own sites for common vulnerabilities"""

    def __init__(self, base_url):
        self.base_url = base_url
        self.findings = []
        self.session = requests.Session()

    def check_security_headers(self):
        """Check for security headers"""
        print("\nüîê Checking security headers...")

        try:
            response = self.session.get(self.base_url, timeout=10)
            headers = response.headers

            required_headers = {
                'Strict-Transport-Security': 'HSTS',
                'X-Frame-Options': 'Clickjacking protection',
                'X-Content-Type-Options': 'MIME sniffing protection',
                'Content-Security-Policy': 'XSS protection',
                'X-XSS-Protection': 'Legacy XSS protection',
            }

            for header, description in required_headers.items():
                if header in headers:
                    print(f"   ‚úÖ {header}: {headers[header][:50]}")
                else:
                    print(f"   ‚ùå Missing: {header} ({description})")
                    self.findings.append({
                        'severity': 'medium',
                        'type': 'missing_header',
                        'header': header,
                        'description': description
                    })

        except Exception as e:
            print(f"   ‚ö†Ô∏è  Error checking headers: {e}")

    def check_https(self):
        """Verify HTTPS is enforced"""
        print("\nüîí Checking HTTPS enforcement...")

        try:
            # Try HTTP
            http_url = self.base_url.replace('https://', 'http://')
            response = self.session.get(http_url, timeout=10, allow_redirects=False)

            if response.status_code in [301, 302, 307, 308]:
                if 'https://' in response.headers.get('Location', ''):
                    print("   ‚úÖ HTTP redirects to HTTPS")
                else:
                    print("   ‚ö†Ô∏è  HTTP redirects but not to HTTPS")
                    self.findings.append({
                        'severity': 'high',
                        'type': 'insecure_redirect',
                        'description': 'HTTP does not redirect to HTTPS'
                    })
            else:
                print("   ‚ùå HTTP is accessible without redirect")
                self.findings.append({
                    'severity': 'critical',
                    'type': 'no_https_redirect',
                    'description': 'HTTP accessible without HTTPS redirect'
                })

        except Exception as e:
            print(f"   ‚úÖ HTTP not accessible (good!)")

    def check_sensitive_files(self):
        """Check for exposed sensitive files"""
        print("\nüìÑ Checking for exposed sensitive files...")

        sensitive_paths = [
            '.env',
            '.git/config',
            'config.json',
            'api_keys.json',
            '.env.local',
            'backup.sql',
            'database.db',
        ]

        for path in sensitive_paths:
            url = urljoin(self.base_url, path)
            try:
                response = self.session.get(url, timeout=5)
                if response.status_code == 200:
                    print(f"   ‚ùå EXPOSED: {path}")
                    self.findings.append({
                        'severity': 'critical',
                        'type': 'exposed_file',
                        'path': path,
                        'url': url
                    })
                else:
                    print(f"   ‚úÖ Protected: {path}")
            except:
                print(f"   ‚úÖ Protected: {path}")

    def check_common_vulnerabilities(self):
        """Check for common web vulnerabilities"""
        print("\nüêõ Checking for common vulnerabilities...")

        # XSS test (very basic)
        test_payloads = [
            '<script>alert(1)</script>',
            '"><script>alert(1)</script>',
        ]

        # SQL injection test (very basic)
        sql_payloads = [
            "' OR '1'='1",
            "1' OR '1' = '1",
        ]

        print("   ‚ÑπÔ∏è  Basic XSS/SQLi testing (limited scope)")
        print("   For comprehensive testing, use OWASP ZAP")

    def generate_report(self):
        """Generate vulnerability report"""
        print("\n" + "=" * 80)
        print("üìä VULNERABILITY SCAN REPORT")
        print("=" * 80)

        print(f"\nTarget: {self.base_url}")
        print(f"Scan time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"\nFindings: {len(self.findings)}")

        if not self.findings:
            print("\n‚úÖ No vulnerabilities found!")
        else:
            severity_counts = {}
            for finding in self.findings:
                severity = finding['severity']
                severity_counts[severity] = severity_counts.get(severity, 0) + 1

            print("\nüî¥ Severity Breakdown:")
            for severity in ['critical', 'high', 'medium', 'low']:
                count = severity_counts.get(severity, 0)
                if count > 0:
                    print(f"   {severity.upper()}: {count}")

            print("\nüìã Details:")
            for i, finding in enumerate(self.findings, 1):
                print(f"\n   {i}. [{finding['severity'].upper()}] {finding['type']}")
                print(f"      {finding.get('description', 'No description')}")

        # Save report
        report_dir = Path(r"C:\Users\dwrek\.security\reports")
        report_dir.mkdir(parents=True, exist_ok=True)

        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        report_file = report_dir / f"vuln_scan_{timestamp}.json"

        report_data = {
            'target': self.base_url,
            'scan_time': datetime.now().isoformat(),
            'findings': self.findings
        }

        report_file.write_text(json.dumps(report_data, indent=2))
        print(f"\nüíæ Report saved to: {report_file}")

def main():
    """Run vulnerability scan"""
    print()
    print("üåå" * 40)
    print()
    print("        SITE VULNERABILITY SCANNER")
    print("        Authorized Testing Only")
    print()
    print("üåå" * 40)

    # Scan our site
    scanner = VulnerabilityScanner('https://conciousnessrevolution.io')
    scanner.check_security_headers()
    scanner.check_https()
    scanner.check_sensitive_files()
    scanner.check_common_vulnerabilities()
    scanner.generate_report()

    print("\n‚úÖ Scan complete!")

if __name__ == "__main__":
    main()
