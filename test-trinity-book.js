// Test Trinity with book writing task
// Uses native fetch (Node 18+)

const fs = require('fs');
const BASE_URL = 'http://localhost:3100';
let sessionCookie = null;

async function login() {
    console.log('ğŸ” Logging in as existing test user...');
    const response = await fetch(`${BASE_URL}/api/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            username: 'testuser_1762410005887',
            password: 'testpass123'
        })
    });

    // Get session cookie
    const cookies = response.headers.get('set-cookie');
    if (cookies) {
        sessionCookie = cookies.split(';')[0];
    }

    const data = await response.json();
    console.log('âœ… Logged in:', data.user.username);
}

async function askTrinityToWriteBook() {
    console.log('\nğŸ“š Reading framework document...');
    const framework = fs.readFileSync('TRINITY_FRAMEWORK_LEARNINGS.md', 'utf8');

    console.log('ğŸ“– Framework loaded:', framework.split('\n').length, 'lines');
    console.log('\nğŸ”± Sending book writing task to Trinity C2 Architect...\n');

    const bookPrompt = `You are C2 Architect, the strategic mastermind of the Trinity AI system.

I'm providing you with a comprehensive framework document that details everything we learned while building the Trinity multi-agent AI system for the 100X Platform.

Your task: Write an outline for a technical book called "The Trinity Paradigm: Building Cost-Effective Multi-Agent AI Systems"

The book should be aimed at:
- Software engineers who want to deploy AI economically
- Startup founders building AI products on a budget
- Technical leaders making AI architecture decisions

Based on the framework document below, create:

1. A compelling book title and subtitle
2. A table of contents with 10-12 chapters
3. A brief description of what each chapter covers
4. Key takeaways readers will gain
5. Target audience definition
6. Estimated book length (pages)

Make it practical, actionable, and focused on real-world implementation.

Here's the framework document to work from:

---

${framework}

---

Now, create the book outline.`;

    const response = await fetch(`${BASE_URL}/api/trinity/chat`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Cookie': sessionCookie
        },
        body: JSON.stringify({
            message: bookPrompt,
            agent: 'c2',
            context: {
                task_type: 'book_outline',
                complexity: 'high',
                framework_lines: framework.split('\n').length
            }
        })
    });

    const data = await response.json();

    if (data.error) {
        console.error('âŒ Error:', data.error);
        return;
    }

    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ğŸ“š TRINITY BOOK OUTLINE RESPONSE');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log(`ğŸ¤– Agent: ${data.agent_name}`);
    console.log(`ğŸ“ Role: ${data.role}`);
    console.log(`ğŸ¯ Routing: ${data.routing.mode.toUpperCase()}`);
    console.log(`ğŸ’­ Reason: ${data.routing.reason}`);
    console.log(`\nğŸ’¬ Response:\n`);
    console.log(data.message);
    console.log(`\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
    console.log('ğŸ“ˆ STATS:');
    console.log(`   Cost Today: $${data.stats.daily_cost.toFixed(4)}`);
    console.log(`   Requests: ${data.stats.requests_today}`);
    console.log(`   Budget Remaining: $${data.stats.budget_remaining.toFixed(2)}`);
    console.log(`   Daily Limit: $${data.stats.daily_limit.toFixed(2)}`);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

    // Save response to file
    const outputFile = 'TRINITY_BOOK_OUTLINE.md';
    fs.writeFileSync(outputFile, `# Trinity Book Outline\n\n**Generated by:** ${data.agent_name}\n**Date:** ${data.timestamp}\n**Routing Mode:** ${data.routing.mode}\n\n---\n\n${data.message}\n`);
    console.log(`ğŸ’¾ Book outline saved to: ${outputFile}`);
}

async function run() {
    try {
        await login();
        await askTrinityToWriteBook();
        console.log('\nâœ… Book writing task completed!');
    } catch (error) {
        console.error('âŒ Error:', error.message);
        console.error(error.stack);
    }
    process.exit(0);
}

run();
