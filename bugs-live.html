<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Bug Monitor - Auto-Refresh</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff88;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #00ff88;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .status {
            font-size: 1.2rem;
            color: #00ffff;
        }

        .refresh-info {
            color: #888;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .debug-info {
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid #ffaa00;
            color: #ffaa00;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .bug-list {
            max-width: 1200px;
            margin: 0 auto;
        }

        .bug-item {
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid #00ff88;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bug-new {
            border: 2px solid #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .bug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .bug-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #00ffff;
        }

        .bug-number {
            background: #00ff88;
            color: #000;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: bold;
        }

        .bug-meta {
            display: flex;
            gap: 2rem;
            margin-bottom: 1rem;
            color: #888;
            font-size: 0.9rem;
        }

        .bug-description {
            color: #e8e8e8;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .bug-link {
            color: #00ffff;
            text-decoration: none;
            font-weight: bold;
        }

        .bug-link:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            font-size: 1.5rem;
            color: #00ffff;
            padding: 3rem;
        }

        .error {
            background: rgba(255, 68, 68, 0.2);
            border: 2px solid #ff4444;
            color: #ff4444;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }

        .new-badge {
            background: #00ffff;
            color: #000;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 1rem;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            padding: 0 2rem;
        }

        .tab-btn {
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid #00ff88;
            color: #00ff88;
            padding: 0.8rem 2rem;
            font-size: 1.1rem;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: #00ff88;
            color: #000;
            font-weight: bold;
        }

        .tab-count {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        .bug-state-open {
            color: #00ff88;
        }

        .bug-state-closed {
            color: #ff4444;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üêõ LIVE BUG MONITOR üêõ</h1>
        <div class="status">
            <span id="bugCount">Loading...</span> bugs tracked
        </div>
        <div class="refresh-info">
            Auto-refresh every 5 seconds ‚Ä¢ Last update: <span id="lastUpdate">--:--:--</span>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" data-filter="all">
            ALL <span class="tab-count" id="countAll">0</span>
        </button>
        <button class="tab-btn" data-filter="open">
            üü¢ OPEN <span class="tab-count" id="countOpen">0</span>
        </button>
        <button class="tab-btn" data-filter="closed">
            üî¥ CLOSED <span class="tab-count" id="countClosed">0</span>
        </button>
    </div>

    <div id="debugInfo" class="debug-info" style="display: none;">
        Debug: <span id="debugText">Starting...</span>
    </div>

    <div class="bug-list" id="bugList">
        <div class="loading">‚ö° Loading bugs...</div>
    </div>

    <script>
        let lastBugCount = 0;
        let knownBugs = new Set();
        let loadAttempt = 0;
        let currentFilter = 'all';
        let allBugsData = [];

        function updateDebug(msg) {
            const debugDiv = document.getElementById('debugInfo');
            const debugText = document.getElementById('debugText');
            debugDiv.style.display = 'block';
            debugText.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            console.log('[DEBUG]', msg);
        }

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Update active state
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Update filter
                    currentFilter = tab.getAttribute('data-filter');

                    // Re-render with filter
                    renderBugs(allBugsData);
                });
            });
        }

        function updateTabCounts(bugs) {
            const openCount = bugs.filter(b => b.state === 'open').length;
            const closedCount = bugs.filter(b => b.state === 'closed').length;

            document.getElementById('countAll').textContent = bugs.length;
            document.getElementById('countOpen').textContent = openCount;
            document.getElementById('countClosed').textContent = closedCount;
        }

        function renderBugs(bugs) {
            const bugList = document.getElementById('bugList');

            // Filter bugs based on current tab
            let filteredBugs = bugs;
            if (currentFilter === 'open') {
                filteredBugs = bugs.filter(b => b.state === 'open');
            } else if (currentFilter === 'closed') {
                filteredBugs = bugs.filter(b => b.state === 'closed');
            }

            // Check for new bugs
            const newBugNumbers = bugs.map(b => b.number).filter(n => !knownBugs.has(n));
            bugs.forEach(b => knownBugs.add(b.number));

            if (filteredBugs.length === 0) {
                bugList.innerHTML = `<div class="loading">No ${currentFilter === 'all' ? '' : currentFilter} bugs</div>`;
                return;
            }

            bugList.innerHTML = '';
            filteredBugs.forEach(bug => {
                const isNew = newBugNumbers.includes(bug.number);
                const bugDiv = document.createElement('div');
                bugDiv.className = 'bug-item' + (isNew ? ' bug-new' : '');

                const stateEmoji = bug.state === 'open' ? 'üü¢' : 'üî¥';
                const stateClass = bug.state === 'open' ? 'bug-state-open' : 'bug-state-closed';

                bugDiv.innerHTML = `
                    <div class="bug-header">
                        <div class="bug-title">
                            ${bug.title}
                            ${isNew ? '<span class="new-badge">NEW!</span>' : ''}
                        </div>
                        <div class="bug-number">#${bug.number}</div>
                    </div>
                    <div class="bug-meta">
                        <div>üë§ ${bug.user.login}</div>
                        <div>üìÖ ${new Date(bug.created_at).toLocaleString()}</div>
                        <div class="${stateClass}">${stateEmoji} ${bug.state.toUpperCase()}</div>
                    </div>
                    <div class="bug-description">${bug.body || 'No description provided'}</div>
                    <a href="${bug.html_url}" target="_blank" class="bug-link">View on GitHub ‚Üí</a>
                `;

                bugList.appendChild(bugDiv);
            });

            // Alert for new bugs
            if (newBugNumbers.length > 0 && lastBugCount > 0) {
                console.log(`üö® ${newBugNumbers.length} NEW BUG(S) DETECTED!`);
                updateDebug(`üö® NEW BUGS: #${newBugNumbers.join(', #')}`);
            }
        }

        async function loadBugs() {
            loadAttempt++;
            try {
                updateDebug(`Attempt ${loadAttempt}: Fetching bugs from /.netlify/functions/get-all-bugs...`);

                const response = await fetch('/.netlify/functions/get-all-bugs');
                updateDebug(`Response received: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const bugs = await response.json();
                updateDebug(`Successfully loaded ${bugs.length} bugs`);

                // Store all bugs
                allBugsData = bugs;

                // Update count
                document.getElementById('bugCount').textContent = bugs.length;

                // Update last update time
                const now = new Date();
                document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();

                // Update tab counts
                updateTabCounts(bugs);

                // Render bugs with current filter
                renderBugs(bugs);

                lastBugCount = bugs.length;

            } catch (error) {
                console.error('Error loading bugs:', error);
                updateDebug(`ERROR: ${error.message}`);
                document.getElementById('bugList').innerHTML = `
                    <div class="error">
                        ‚ùå Error loading bugs<br>
                        ${error.message}<br>
                        <small>Retrying in 5 seconds...</small><br>
                        <small style="margin-top: 1rem; display: block;">Attempt ${loadAttempt} - Check console (F12) for details</small>
                    </div>
                `;
            }
        }

        // Wait for DOM to be fully ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                updateDebug('DOM ready, starting bug monitor...');
                setupTabs();
                loadBugs();
                setInterval(loadBugs, 5000);
            });
        } else {
            updateDebug('DOM already ready, starting bug monitor...');
            setupTabs();
            loadBugs();
            setInterval(loadBugs, 5000);
        }
    </script>

    <script src="/SIMPLE_BUG_REPORTER.js"></script>

    <script src="/UNIVERSAL_USER_DISPLAY.js"></script>
</body>
</html>
