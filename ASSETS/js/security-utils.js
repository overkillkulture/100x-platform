/**
 * üõ°Ô∏è SECURITY UTILITIES - XSS Protection & Input Sanitization
 *
 * Purpose: Prevent code injection and secure all user input handling
 * Pattern: Defensive programming - validate everything
 *
 * Generated by: C1 Mechanic (Security Hardening)
 * Authorized by: Commander - October 17, 2025
 */

/**
 * SafeDOM - Secure DOM manipulation wrapper
 * Prevents XSS attacks by sanitizing all content before insertion
 */
const SafeDOM = {
  /**
   * Safely set text content (no HTML parsing)
   * USE THIS instead of innerHTML for text
   */
  setText: function(element, text) {
    if (typeof element === 'string') {
      element = document.getElementById(element) || document.querySelector(element);
    }
    if (element) {
      element.textContent = text;
    }
  },

  /**
   * Safely set HTML with sanitization
   * Only use when you MUST insert HTML
   */
  setHTML: function(element, html) {
    if (typeof element === 'string') {
      element = document.getElementById(element) || document.querySelector(element);
    }
    if (element) {
      element.innerHTML = this.sanitizeHTML(html);
    }
  },

  /**
   * Sanitize HTML to prevent XSS
   * Removes <script>, event handlers, and dangerous attributes
   */
  sanitizeHTML: function(html) {
    // Create temporary div to parse HTML
    const temp = document.createElement('div');
    temp.textContent = html; // First set as text
    let cleaned = temp.innerHTML; // Then get escaped version

    // Remove script tags completely
    cleaned = cleaned.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');

    // Remove event handlers (onclick, onload, onerror, etc.)
    cleaned = cleaned.replace(/\son\w+\s*=\s*["'][^"']*["']/gi, '');
    cleaned = cleaned.replace(/\son\w+\s*=\s*[^\s>]*/gi, '');

    // Remove javascript: protocol
    cleaned = cleaned.replace(/javascript:/gi, '');

    // Remove data: protocol (can be used for XSS)
    cleaned = cleaned.replace(/data:text\/html/gi, '');

    return cleaned;
  },

  /**
   * Escape HTML special characters
   * Use this for displaying user input as text
   */
  escapeHTML: function(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
  },

  /**
   * Safely create element with attributes
   */
  createElement: function(tag, attributes = {}, textContent = '') {
    const element = document.createElement(tag);

    // Whitelist of safe attributes
    const safeAttributes = ['class', 'id', 'href', 'src', 'alt', 'title', 'target', 'rel'];

    for (const [key, value] of Object.entries(attributes)) {
      if (safeAttributes.includes(key)) {
        // Sanitize href and src
        if (key === 'href' || key === 'src') {
          if (this.isSafeURL(value)) {
            element.setAttribute(key, value);
          }
        } else {
          element.setAttribute(key, value);
        }
      }
    }

    if (textContent) {
      element.textContent = textContent;
    }

    return element;
  },

  /**
   * Check if URL is safe (not javascript: or data:)
   */
  isSafeURL: function(url) {
    const lower = url.toLowerCase().trim();
    return !lower.startsWith('javascript:') &&
           !lower.startsWith('data:') &&
           !lower.startsWith('vbscript:');
  }
};

/**
 * SafeInput - Secure input validation wrapper
 * Validates and sanitizes all user input
 */
const SafeInput = {
  /**
   * Validate email format
   */
  isValidEmail: function(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email);
  },

  /**
   * Validate password strength
   */
  isValidPassword: function(password, minLength = 4) {
    return password && password.length >= minLength;
  },

  /**
   * Sanitize string input (remove control characters)
   */
  sanitizeString: function(input, maxLength = 1000) {
    if (typeof input !== 'string') return '';

    // Remove control characters
    let clean = input.replace(/[\x00-\x1F\x7F]/g, '');

    // Trim whitespace
    clean = clean.trim();

    // Limit length
    if (clean.length > maxLength) {
      clean = clean.substring(0, maxLength);
    }

    return clean;
  },

  /**
   * Validate number input
   */
  sanitizeNumber: function(input, min = null, max = null) {
    const num = parseInt(input, 10);
    if (isNaN(num)) return null;

    if (min !== null && num < min) return min;
    if (max !== null && num > max) return max;

    return num;
  },

  /**
   * Sanitize JSON input
   */
  sanitizeJSON: function(input) {
    try {
      const parsed = JSON.parse(input);
      return JSON.stringify(parsed); // Re-stringify to clean
    } catch (error) {
      console.error('Invalid JSON input:', error);
      return null;
    }
  }
};

/**
 * SafeStorage - Secure localStorage wrapper
 * Prevents storage of sensitive data and validates before storing
 */
const SafeStorage = {
  /**
   * Safely set item in localStorage
   * NEVER USE THIS FOR PASSWORDS - use backend only
   */
  setItem: function(key, value) {
    // Blacklist sensitive keys
    const sensitiveKeys = ['password', 'secret', 'apiKey', 'token', 'auth_token'];
    const keyLower = key.toLowerCase();

    for (const sensitive of sensitiveKeys) {
      if (keyLower.includes(sensitive) && !keyLower.includes('jwt_token')) {
        console.error('üö® SECURITY: Blocked attempt to store sensitive data in localStorage:', key);
        return false;
      }
    }

    try {
      localStorage.setItem(key, typeof value === 'object' ? JSON.stringify(value) : value);
      return true;
    } catch (error) {
      console.error('Storage error:', error);
      return false;
    }
  },

  /**
   * Safely get item from localStorage
   */
  getItem: function(key) {
    try {
      const value = localStorage.getItem(key);
      if (!value) return null;

      // Try to parse as JSON
      try {
        return JSON.parse(value);
      } catch (e) {
        return value;
      }
    } catch (error) {
      console.error('Storage retrieval error:', error);
      return null;
    }
  },

  /**
   * Remove item from localStorage
   */
  removeItem: function(key) {
    try {
      localStorage.removeItem(key);
      return true;
    } catch (error) {
      console.error('Storage removal error:', error);
      return false;
    }
  },

  /**
   * Clear all storage (with confirmation)
   */
  clearAll: function(confirmed = false) {
    if (!confirmed) {
      console.warn('‚ö†Ô∏è clearAll requires confirmed=true parameter');
      return false;
    }
    try {
      localStorage.clear();
      return true;
    } catch (error) {
      console.error('Storage clear error:', error);
      return false;
    }
  }
};

/**
 * SafeAPI - Secure API call wrapper
 * Wraps window.api with additional error handling
 */
const SafeAPI = {
  /**
   * Make API call with timeout and retry logic
   */
  call: async function(method, ...args) {
    if (!window.api || typeof window.api[method] !== 'function') {
      throw new Error(`API method not available: ${method}`);
    }

    const timeout = 30000; // 30 second timeout
    const maxRetries = 3;

    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        // Create timeout promise
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('API call timeout')), timeout);
        });

        // Race between API call and timeout
        const apiPromise = window.api[method](...args);
        const result = await Promise.race([apiPromise, timeoutPromise]);

        return result;

      } catch (error) {
        console.error(`API call failed (attempt ${attempt}/${maxRetries}):`, error.message);

        if (attempt === maxRetries) {
          throw error;
        }

        // Wait before retry (exponential backoff)
        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
      }
    }
  }
};

// Make available globally
window.SafeDOM = SafeDOM;
window.SafeInput = SafeInput;
window.SafeStorage = SafeStorage;
window.SafeAPI = SafeAPI;

console.log('üõ°Ô∏è Security utilities loaded - XSS protection active');
